<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAMASTE - Powered by APNA ADDA</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00e676; 
            --primary-dark: #00b248;
            --bg-color: #000000; 
            --card-bg: #121212; 
            --text-main: #ffffff; 
            --text-sec: #b0bec5; 
            --danger: #ff1744; 
            --admin-color: #7289da;
            --border: #333333;
            --insta-blue: #3897f0;
            --font: 'Poppins', sans-serif;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font); background-color: var(--bg-color); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .animate-entry { animation: fadeIn 0.5s ease-out forwards; }
        .slide-right { animation: slideInRight 0.3s ease-out forwards; }
        .slide-up { animation: slideInUp 0.3s ease-out forwards; }
        .hidden { display: none !important; }

        /* --- UI Components --- */
        button { cursor: pointer; font-family: var(--font); border: none; outline: none; transition: 0.3s; }
        
        .btn-primary {
            background-color: var(--primary); color: #000; font-weight: 700;
            padding: 12px 24px; border-radius: 30px; font-size: 1rem; width: 100%;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4);
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-outline {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            font-weight: 600; padding: 12px 24px; border-radius: 30px; width: 100%; margin-top: 10px;
        }

        .btn-danger { background-color: var(--danger); color: white; border: none; box-shadow: none; }
        
        .google-btn {
            background: white; color: #333; font-weight: 600; margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .or-divider {
            display: flex; align-items: center; color: var(--text-sec); margin: 20px 0; font-size: 0.9rem;
        }
        .or-divider::before, .or-divider::after {
            content: ""; flex: 1; height: 1px; background: #333;
        }
        .or-divider::before { margin-right: 10px; }
        .or-divider::after { margin-left: 10px; }

        input {
            width: 100%; background: var(--card-bg); border: 1px solid var(--border);
            color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* Blue Tick & Message Status */
        .verified-badge {
            display: inline-flex; align-items: center; justify-content: center; position: relative;
            margin-left: 6px; width: 18px; height: 18px; vertical-align: middle;
        }
        .verified-badge .fa-certificate { color: var(--insta-blue); font-size: 18px; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }
        .verified-badge .fa-check { color: white; font-size: 9px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .msg-status { font-size: 0.7rem; margin-left: 5px; color: #888; } 
        .msg-status.seen { color: var(--insta-blue); } 

        /* --- Screen Containers --- */
        .screen { 
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; 
            background: var(--bg-color); display: flex; flex-direction: column; overflow-y: auto;
        }

        /* 1. Home Screen */
        #home-screen { padding: 20px; text-align: center; overflow-y: scroll; }
        .hero-title { font-size: 2.5rem; font-weight: 800; letter-spacing: 2px; margin-top: 40px; }
        .hero-subtitle { color: var(--primary); font-size: 0.9rem; letter-spacing: 1px; margin-bottom: 30px; font-weight: 600; text-transform: uppercase; }
        
        .feature-card { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: left; border-left: 4px solid var(--primary); }
        .feature-card h3 { color: var(--primary); font-size: 1.1rem; margin-bottom: 5px; }
        .feature-card p { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; }
        .feature-card a { color: var(--primary); text-decoration: underline; }

        .about-section { margin-top: 30px; text-align: left; background: #1a1a1a; padding: 20px; border-radius: 15px; margin-bottom: 80px;}
        .about-section h2 { color: var(--primary); margin-bottom: 10px; }
        .about-section p { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px; line-height: 1.5; }

        .footer { margin-top: 20px; padding-bottom: 40px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .footer-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 20px; background: #222; color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid #333; }

        /* 2. Auth & Setup */
        .auth-container { display: flex; flex-direction: column; justify-content: center; height: 100%; padding: 30px; max-width: 500px; margin: 0 auto; width: 100%; }
        .emoji-picker { font-size: 3rem; text-align: center; margin: 20px auto; cursor: pointer; border: 2px dashed var(--border); border-radius: 50%; width: 100px; height: 100px; line-height: 90px; }

        /* 3. Main App Layout */
        .app-header {
            padding: 15px 20px; background: rgba(10,10,10,0.95); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
            width: 100%;
        }
        .app-logo { font-weight: 800; font-size: 1.2rem; }
        .app-logo span { color: var(--primary); font-size: 0.8rem; display: block; font-weight: 400; }
        
        .dropdown-menu {
            position: absolute; right: 10px; top: 50px; background: #1a1a1a; border: 1px solid var(--border);
            border-radius: 8px; width: 180px; display: none; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.8); z-index: 101;
        }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px; font-size: 0.9rem; color: white; cursor: pointer; border-bottom: 1px solid #333; }
        .dropdown-item:hover { background: #222; }

        .content-area { flex: 1; overflow-y: auto; padding-bottom: 70px; width: 100%; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; transition: 0.3s;
        }
        .nav-item { color: var(--text-sec); text-align: center; font-size: 0.7rem; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.admin-active { color: var(--admin-color); }

        /* DESKTOP SIDEBAR LOGIC */
        @media (min-width: 768px) {
            .bottom-nav {
                top: 0; left: 0; width: var(--sidebar-width); height: 100vh;
                flex-direction: column; justify-content: flex-start;
                padding-top: 80px; border-top: none; border-right: 1px solid var(--border);
                align-items: center;
            }
            .nav-item { flex: 0; margin-bottom: 30px; width: 100%; text-align: left; padding-left: 40px; display: flex; align-items: center; gap: 15px; font-size: 1rem; }
            .nav-item i { font-size: 1.2rem; margin-bottom: 0; display: inline-block; width: 30px; }
            
            .content-area { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); padding-bottom: 0; }
            .app-header { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        }

        .user-list-item {
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;
        }
        .user-list-item:active, .user-list-item:hover { background: #1a1a1a; }
        .avatar { width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; border: 2px solid var(--primary); flex-shrink: 0; }
        .user-info { flex: 1; min-width: 0; }
        .user-name { font-weight: 600; color: white; font-size: 1rem; display: flex; align-items: center;}
        .user-meta { font-size: 0.8rem; color: var(--text-sec); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 4. Chat Room & Input Area */
        #chat-room {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 900; 
            display: flex; flex-direction: column;
        }

        .chat-header {
            padding: 10px 15px; background: var(--card-bg); display: flex; align-items: center; border-bottom: 1px solid var(--border); height: 60px;
        }
        .back-btn { font-size: 1.2rem; color: white; margin-right: 15px; cursor: pointer; padding: 5px; }
        .chat-title { display: flex; align-items: center; flex: 1; cursor: pointer;}
        .chat-title .avatar { width: 35px; height: 35px; font-size: 1.2rem; margin-right: 10px; border-width: 1px; }
        
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #000; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; position: relative; word-wrap: break-word; animation: fadeIn 0.3s; }
        .msg-sent { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 2px; }
        .msg-time { font-size: 0.65rem; opacity: 0.7; display: block; text-align: right; margin-top: 4px; }
        .msg-delete { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: none; align-items: center; justify-content: center; cursor: pointer;}
        .message:hover .msg-delete { display: flex; }

        .chat-input-area {
            padding: 10px; background: var(--card-bg); display: flex; align-items: center; gap: 10px; width: 100%;
        }
        .chat-input { flex: 1; background: #222; border: none; border-radius: 20px; color: white; padding: 10px 15px; margin: 0; }
        .chat-action-btn { color: var(--primary); font-size: 1.4rem; padding: 8px; cursor: pointer; transition: 0.2s; }

        /* Block Status UI */
        .blocked-msg-bar {
            background: #222; color: #ff5252; text-align: center; padding: 15px; 
            font-size: 0.9rem; border-top: 1px solid #333; display: none;
        }
        .unblock-btn-bar {
            background: var(--card-bg); padding: 10px; display: none; justify-content: center;
            border-top: 1px solid #333;
        }

        /* 5. Profile Preview & Admin */
        .profile-view-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 1000; 
            display: flex; flex-direction: column; padding: 20px;
        }
        .profile-view-header { display: flex; align-items: center; margin-bottom: 40px; }
        .profile-view-content { flex: 1; display: flex; flex-direction: column; align-items: center; margin-top: 50px; }

        .admin-user-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #333; }
        .admin-user-info { display: flex; align-items: center; gap: 10px; flex: 1;}
        .admin-actions { display: flex; gap: 5px; }

        /* Utils */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(50, 50, 50, 0.9); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000;
        }
        .toast.show { opacity: 1; bottom: 90px; }

        .confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 2500; display: none; align-items: center; justify-content: center;
        }
        .confirm-box { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--border); }
        .confirm-actions { display: flex; gap: 10px; margin-top: 20px; }

    </style>
</head>
<body>

    <div id="toast" class="toast">Notification</div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="confirm-overlay">
        <div class="confirm-box">
            <h3 id="confirm-title" style="color:white; margin-bottom:10px;">Confirm</h3>
            <p id="confirm-msg" style="color:#aaa;">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn-outline" style="margin:0;" onclick="closeConfirm()">Cancel</button>
                <button class="btn-primary btn-danger" style="margin:0;" id="confirm-yes-btn">Yes</button>
            </div>
        </div>
    </div>

    <!-- 1. HOME SCREEN -->
    <div id="home-screen" class="screen animate-entry">
        <h1 class="hero-title">NAMASTE</h1>
        <p class="hero-subtitle">POWERED BY APNA ADDA</p>
        
        <button id="get-started-btn" class="btn-primary" onclick="handleGetStarted()">Get Started</button>

        <div style="margin-top: 30px;">
            <div class="feature-card" style="border-left-color: var(--insta-blue);">
                <h3 style="color: var(--insta-blue);">Get Verified!</h3>
                <p>Users who join both our <a href="https://t.me/apnaadda_official" target="_blank">Telegram</a> and <a href="https://whatsapp.com/channel/0029VbBpBIy2UPBEjwKlZh18" target="_blank">WhatsApp</a> channels can get the Blue Tick verified badge.</p>
            </div>
            <div class="feature-card">
                <h3>End-to-end encrypted</h3>
                <p>100% private & secure environment. Your messages are protected.</p>
            </div>
            <div class="feature-card">
                <h3>Fast messaging</h3>
                <p>Real-time data transmission ensures your texts are delivered instantly.</p>
            </div>
            <div class="feature-card">
                <h3>Powered by APNA ADDA</h3>
                <p>Technology for everyday growth. <a href="https://apnaaddatech.github.io/Official_/" target="_blank">CLICK HERE FOR OFFICIAL WEB</a></p>
            </div>
        </div>

        <div class="about-section">
            <h2>About Us</h2>
            <p>APNA ADDA is a technology-driven company committed to building smart, simple, and useful digital solutions for everyday life.</p>
            <p>The company was founded and is owned by Premanshu Kumar, a passionate developer focused on creating meaningful digital products that solve real-world problems.</p>
            <p><strong>APNA ADDA ‚Äì Technology for Everyday Growth.</strong></p>
        </div>

        <div class="footer">
            <a href="mailto:thepremanshu@gmail.com" class="footer-btn"><i class="fas fa-envelope"></i> Contact</a>
            <a href="https://t.me/apnaadda_official" target="_blank" class="footer-btn"><i class="fab fa-telegram"></i> Telegram</a>
            <a href="https://whatsapp.com/channel/0029VbBpBIy2UPBEjwKlZh18" target="_blank" class="footer-btn"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        </div>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="auth-screen" class="screen hidden">
        <div class="auth-container">
            <h2 class="hero-title" style="margin-top:0">Welcome</h2>
            <p class="hero-subtitle">Log in to NAMASTE</p>
            
            <div id="auth-forms">
                <div id="login-form">
                    <input type="email" id="login-email" placeholder="Email Address">
                    <input type="password" id="login-pass" placeholder="Password">
                    <button class="btn-primary" onclick="login()">Login</button>
                    
                    <div class="or-divider">OR</div>
                    <button class="btn-primary google-btn" onclick="googleLogin()">
                        <i class="fab fa-google"></i> Continue with Google
                    </button>

                    <button class="btn-outline" onclick="toggleAuthMode()">Create Account</button>
                </div>
                <div id="signup-form" class="hidden">
                    <input type="email" id="signup-email" placeholder="Email Address">
                    <input type="password" id="signup-pass" placeholder="Password">
                    <button class="btn-primary" onclick="signup()">Sign Up</button>
                    <button class="btn-outline" onclick="toggleAuthMode()">Back to Login</button>
                </div>
            </div>
            <button class="btn-outline" style="border:none; margin-top: 20px; color: #666;" onclick="showScreen('home-screen')">Back Home</button>
        </div>
    </div>

    <!-- 3. PROFILE SETUP -->
    <div id="setup-screen" class="screen hidden">
        <div class="auth-container">
            <h2 style="color:white; margin-bottom:20px;">Profile Setup</h2>
            <div class="emoji-picker" id="setup-emoji-disp" onclick="cycleEmoji()">üòé</div>
            <p style="text-align:center; color:gray; font-size:0.8rem; margin-bottom:20px;">Tap emoji to change</p>
            <input type="text" id="setup-name" placeholder="Full Name">
            <input type="text" id="setup-username" placeholder="Unique Username ID (no spaces)">
            <button class="btn-primary" onclick="saveProfile()">Save & Continue</button>
        </div>
    </div>

    <!-- 4. MAIN APP -->
    <div id="main-app-screen" class="screen hidden">
        <header class="app-header">
            <div class="app-logo">NAMASTE <span>BY APNA ADDA</span></div>
            <div style="position:relative;">
                <i class="fas fa-ellipsis-v" style="color:white; padding:10px; cursor:pointer;" onclick="toggleMainMenu()"></i>
                <div id="main-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="showBlockedList()">Blocked Users</div>
                    <div class="dropdown-item" onclick="showScreen('home-screen')">Home Page</div>
                    <div class="dropdown-item" onclick="logout()" style="color:var(--danger)">Logout</div>
                </div>
            </div>
        </header>

        <div class="content-area" id="tab-content">
            <div id="tab-chats">
                <div style="padding:15px; color:gray; font-size:0.8rem;" id="chat-list-container">Loading chats...</div>
            </div>
            <div id="tab-search" class="hidden" style="padding:15px;">
                <input type="text" id="search-input" placeholder="Search by Username ID..." onkeyup="handleSearch()">
                <div id="search-results"></div>
            </div>
            <div id="tab-profile" class="hidden" style="padding:20px; text-align:center;">
                <div class="emoji-picker" id="my-profile-emoji" onclick="editProfileEmoji()"></div>
                <h3 id="profile-name-display" style="color:white; margin-bottom:10px; display:flex; justify-content:center; align-items:center;"></h3>
                <input type="text" id="edit-name" placeholder="Full Name">
                <input type="text" id="edit-username" placeholder="Username" readonly style="opacity: 0.7; cursor: not-allowed;">
                <button class="btn-primary" onclick="updateProfile()">Update Profile</button>
            </div>
            <div id="tab-blocked" class="hidden" style="padding:15px;">
                <h3 style="color:white; margin-bottom:15px;">Blocked Users</h3>
                <div id="blocked-list-container"></div>
                <button class="btn-outline" onclick="switchTab('chats')">Back to Chats</button>
            </div>
            <div id="tab-admin" class="hidden" style="padding:15px;">
                <h3 style="color:var(--admin-color); margin-bottom:15px;">Admin Dashboard</h3>
                <div id="admin-user-list"></div>
            </div>
        </div>

        <!-- Sidebar / Footer -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('chats')" id="nav-chats">
                <i class="fas fa-comment-alt"></i> <span>Chats</span>
            </div>
            <div class="nav-item" onclick="switchTab('search')" id="nav-search">
                <i class="fas fa-search"></i> <span>Search</span>
            </div>
            <div class="nav-item" onclick="switchTab('profile')" id="nav-profile">
                <i class="fas fa-user"></i> <span>Profile</span>
            </div>
            <div class="nav-item hidden" onclick="switchTab('admin')" id="nav-admin">
                <i class="fas fa-shield-alt"></i> <span>Admin</span>
            </div>
        </div>
    </div>

    <!-- 5. CHAT ROOM (FULL SCREEN OVERLAY) -->
    <div id="chat-room" class="hidden slide-right">
        <header class="chat-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
            <div class="chat-title" onclick="viewChatProfile()">
                <div class="avatar" id="chat-header-emoji"></div>
                <div>
                    <div class="user-name" id="chat-header-name">User</div>
                </div>
            </div>
            <div style="position:relative;">
                <i class="fas fa-ellipsis-v" style="color:white; padding:10px; cursor:pointer;" onclick="toggleChatMenu()"></i>
                <div id="chat-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="blockCurrentUser()">Block User</div>
                    <div class="dropdown-item" onclick="deleteCurrentChat()" style="color:var(--danger)">Delete Chat</div>
                </div>
            </div>
        </header>

        <div class="messages-container" id="messages-list"></div>

        <!-- Chat Controls: Standard, Blocked by User, Unblock Option -->
        <div class="chat-input-area" id="chat-input-area">
            <input type="text" class="chat-input" id="message-input" placeholder="Type a message...">
            <i class="fas fa-paper-plane chat-action-btn" onclick="sendTextMessage()"></i>
        </div>

        <div id="blocked-msg-bar" class="blocked-msg-bar">
            The user blocked you. You are not able to send message.
        </div>

        <div id="unblock-btn-bar" class="unblock-btn-bar">
            <button class="btn-primary" style="width: auto; background-color: white; color: black;" onclick="unblockCurrentChatUser()">
                UNBLOCK USER
            </button>
        </div>
    </div>

    <!-- 6. USER PROFILE PREVIEW (FULL SCREEN) -->
    <div id="profile-preview" class="profile-view-modal hidden slide-up">
        <div class="profile-view-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeProfilePreview()"></i>
            <span style="font-weight:600; font-size:1.1rem;">User Profile</span>
        </div>
        
        <div class="profile-view-content">
            <div class="avatar" id="preview-emoji" style="width:120px; height:120px; font-size:4rem; margin-bottom:20px; border-width:4px;"></div>
            <h2 id="preview-name" style="color:white; font-size:1.8rem; display:flex; align-items:center;"></h2>
            <p id="preview-username" style="color:var(--primary); font-size:1.1rem; margin-bottom: 40px;"></p>
            
            <button class="btn-primary btn-danger" onclick="blockCurrentUser(); closeProfilePreview();" style="width:80%;">Block User</button>
            <button class="btn-outline" onclick="deleteCurrentChat(); closeProfilePreview();" style="width:80%; margin-top:15px; border-color:var(--danger); color:var(--danger);">Delete Chat</button>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <!-- Using Compat Libraries for Better Browser Compatibility in Single-File Structure -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBIDba-GRUP7Qu2yMChz1jdtwvzJB8gYk",
            authDomain: "namaste-c8b87.firebaseapp.com",
            databaseURL: "https://namaste-c8b87-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "namaste-c8b87",
            storageBucket: "namaste-c8b87.firebasestorage.app",
            messagingSenderId: "517067547428",
            appId: "1:517067547428:web:3338ea60c9af40257109b1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;
        let emojis = ["üòé", "üòä", "üöÄ", "ü¶Å", "üêº", "üî•", "üíé", "üëΩ", "ü§ñ", "üëª"];
        let currentEmojiIdx = 0;
        
        const ADMIN_EMAIL = "thepremanshu@gmail.com";
        // Removed hardcoded password requirement to allow Google Login for Admin

        const tickHTML = `
            <span class="verified-badge">
                <i class="fas fa-certificate"></i>
                <i class="fas fa-check"></i>
            </span>
        `;

        // --- AUTH ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                // Check if user is Admin
                if(user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('nav-admin').classList.remove('hidden');
                } else {
                    document.getElementById('nav-admin').classList.add('hidden');
                }
                
                // CHECK IF USER HAS PROFILE DATA
                db.ref(`users/${user.uid}`).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        // Profile exists, go to app
                        document.getElementById('get-started-btn').innerText = "BACK TO CHAT AREA";
                        
                        // If we are on Auth/Setup screens, move to main app
                        const setupVis = !document.getElementById('setup-screen').classList.contains('hidden');
                        const authVis = !document.getElementById('auth-screen').classList.contains('hidden');
                        if (setupVis || authVis) {
                            showScreen('main-app-screen');
                        }
                    } else {
                        // Profile does NOT exist, force setup
                        showScreen('setup-screen');
                    }
                }).catch(e => {
                    showToast("DB Error: Check Rules");
                    console.error(e);
                });
            } else {
                currentUser = null;
                document.getElementById('get-started-btn').innerText = "Get Started";
                document.getElementById('nav-admin').classList.add('hidden');
                // Ensure we aren't in the app
                if(!document.getElementById('main-app-screen').classList.contains('hidden')){
                    showScreen('home-screen');
                }
            }
        });

        function handleGetStarted() {
            if (currentUser) {
                // Double check profile status
                db.ref(`users/${currentUser.uid}`).once('value').then(s => {
                    if(s.exists()) showScreen('main-app-screen');
                    else showScreen('setup-screen');
                });
            } else {
                showScreen('auth-screen');
            }
        }

        function login() {
            const email = document.getElementById('login-email').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            if(!email || !pass) return showToast("Enter credentials");
            
            // Standard Firebase Login (Removed custom password check to fix admin login)
            auth.signInWithEmailAndPassword(email, pass).catch(e => showToast(e.message));
        }

        function signup() {
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            if(!email || !pass) return showToast("Enter details");
            auth.createUserWithEmailAndPassword(email, pass).then(() => showScreen('setup-screen')).catch(e => showToast(e.message));
        }

        function googleLogin() {
            auth.signInWithPopup(googleProvider).then((result) => {
                // onAuthStateChanged will handle redirection
            }).catch((error) => {
                showToast("Google Auth Failed: " + error.message);
            });
        }

        function logout() {
            confirmAction("Logout", "Are you sure?", () => {
                auth.signOut().then(() => {
                    showScreen('home-screen');
                    showToast("Logged out");
                    location.reload(); 
                });
            });
        }

        function toggleAuthMode() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        }

        // --- PROFILE ---
        function cycleEmoji() {
            currentEmojiIdx = (currentEmojiIdx + 1) % emojis.length;
            document.getElementById('setup-emoji-disp').innerText = emojis[currentEmojiIdx];
        }

        function saveProfile() {
            const name = document.getElementById('setup-name').value;
            let username = document.getElementById('setup-username').value.trim();
            // Remove spaces from username
            username = username.replace(/\s/g, '').toLowerCase();

            if (!name || !username) return showToast("Fill all fields");

            db.ref(`usernames/${username}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showToast("Username already taken");
                } else {
                    const updates = {};
                    updates[`users/${currentUser.uid}`] = { 
                        name: name, 
                        username: username, 
                        emoji: emojis[currentEmojiIdx], 
                        email: currentUser.email, 
                        isVerified: false 
                    };
                    updates[`usernames/${username}`] = currentUser.uid;
                    
                    db.ref().update(updates).then(() => {
                        showScreen('main-app-screen');
                    }).catch(e => {
                        console.error(e);
                        showToast("Error saving. Check DB Rules.");
                    });
                }
            });
        }

        function editProfileEmoji() {
            currentEmojiIdx = (currentEmojiIdx + 1) % emojis.length;
            document.getElementById('my-profile-emoji').innerText = emojis[currentEmojiIdx];
        }

        function updateProfile() {
            const name = document.getElementById('edit-name').value;
            const emoji = document.getElementById('my-profile-emoji').innerText;
            confirmAction("Update", "Save profile changes?", () => {
                db.ref(`users/${currentUser.uid}`).update({ name, emoji }).then(() => {
                    showToast("Profile Updated");
                    // Refresh Display
                    const u = {name, emoji, isVerified: document.getElementById('profile-name-display').innerHTML.includes('fa-certificate')};
                    const badge = u.isVerified ? tickHTML : '';
                    document.getElementById('profile-name-display').innerHTML = u.name + badge;
                });
            });
        }

        // --- ADMIN ---
        function loadAdminList() {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = "Loading users...";
            db.ref('users').once('value', (snapshot) => {
                list.innerHTML = "";
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const u = child.val();
                        const uid = child.key;
                        const div = document.createElement('div');
                        div.className = 'admin-user-row';
                        const badge = u.isVerified ? tickHTML : '';
                        const btnText = u.isVerified ? 'Unverify' : 'Verify';
                        const btnClass = u.isVerified ? 'btn-outline' : 'btn-primary';
                        
                        // Prevent deleting self
                        const delBtn = uid === currentUser.uid ? '' : 
                            `<button class="btn-danger" style="width:auto; padding:5px 15px; font-size:0.8rem; margin:0; border-radius:30px;" onclick="deleteUserAccount('${uid}', '${u.username}')"><i class="fas fa-trash"></i></button>`;

                        div.innerHTML = `
                            <div class="admin-user-info">
                                <div class="avatar" style="width:40px;height:40px;font-size:1.2rem;">${u.emoji}</div>
                                <div><div style="font-weight:bold; display:flex; align-items:center;">${u.name} ${badge}</div><div style="font-size:0.8rem;color:gray;">@${u.username}</div></div>
                            </div>
                            <div class="admin-actions">
                                <button class="${btnClass}" style="width:auto; padding:5px 15px; font-size:0.8rem; margin:0;" onclick="toggleUserVerify('${uid}', ${u.isVerified})">${btnText}</button>
                                ${delBtn}
                            </div>
                        `;
                        list.appendChild(div);
                    });
                } else list.innerHTML = "No users found.";
            });
        }

        function toggleUserVerify(uid, currentStatus) {
            db.ref(`users/${uid}`).update({ isVerified: !currentStatus }).then(() => loadAdminList());
        }

        function deleteUserAccount(uid, username) {
            confirmAction("Delete Account", "Permanently remove this user?", () => {
                const updates = {};
                updates[`users/${uid}`] = null;
                updates[`usernames/${username}`] = null;
                updates[`userChats/${uid}`] = null; // Clean up their chat list
                // Realistically we should clean up all chats referencing them, but this is a start
                db.ref().update(updates).then(() => {
                    showToast("User Deleted");
                    loadAdminList();
                }).catch(e => showToast("Error deleting: " + e.message));
            });
        }

        // --- NAVIGATION ---
        function showScreen(screenId) {
            document.getElementById('chat-room').classList.add('hidden');
            document.getElementById('profile-preview').classList.add('hidden');
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            document.getElementById('main-menu').classList.remove('show');
            
            if (screenId === 'main-app-screen') {
                switchTab('chats');
                // Load own profile for editing
                db.ref(`users/${currentUser.uid}`).once('value').then(s => {
                    if(s.exists()){
                        const u = s.val();
                        document.getElementById('edit-name').value = u.name;
                        document.getElementById('edit-username').value = u.username;
                        document.getElementById('my-profile-emoji').innerText = u.emoji;
                        const badge = u.isVerified ? tickHTML : '';
                        document.getElementById('profile-name-display').innerHTML = u.name + badge;
                    }
                });
            }
        }

        function switchTab(tab) {
            ['chats', 'search', 'profile', 'blocked', 'admin'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) el.classList.add('hidden');
                const nav = document.getElementById(`nav-${t}`);
                if(nav) nav.classList.remove('active', 'admin-active');
            });
            
            const target = document.getElementById(`tab-${tab}`);
            if(target) target.classList.remove('hidden');
            
            const nav = document.getElementById(`nav-${tab}`);
            if(nav) {
                if(tab === 'admin') nav.classList.add('admin-active');
                else nav.classList.add('active');
            }

            if (tab === 'chats') loadChats();
            if (tab === 'admin') loadAdminList();
        }

        function toggleMainMenu() { document.getElementById('main-menu').classList.toggle('show'); }

        // --- SEARCH & CHAT ---
        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            const resDiv = document.getElementById('search-results');
            
            if (query.length < 1) { resDiv.innerHTML = ""; return; }
            
            db.ref(`usernames/${query}`).once('value').then((snapshot) => {
                resDiv.innerHTML = "";
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    if (uid === currentUser.uid) {
                        resDiv.innerHTML = "<p style='color:grey; text-align:center; margin-top:10px'>That's you!</p>";
                        return;
                    }
                    db.ref(`users/${uid}`).once('value').then((userSnap) => {
                        const user = userSnap.val();
                        const badge = user.isVerified ? tickHTML : '';
                        resDiv.innerHTML = `<div class="user-list-item" onclick="openChat('${uid}')"><div class="avatar">${user.emoji}</div><div class="user-info"><div class="user-name">${user.name} ${badge}</div><div class="user-meta">@${user.username}</div></div><button class="btn-primary" style="width:auto; padding:5px 15px; font-size:0.8rem;">Chat</button></div>`;
                    });
                } else {
                    resDiv.innerHTML = "<p style='color:grey; text-align:center; margin-top:10px'>No user found</p>";
                }
            });
        }

        async function openChat(targetUid) {
            try {
                const snap = await db.ref(`users/${targetUid}`).get();
                if(!snap.exists()) return showToast("User no longer exists");
                
                currentChatUser = { ...snap.val(), uid: targetUid };
                // Consistent chat ID generation
                currentChatId = currentUser.uid < targetUid ? `${currentUser.uid}_${targetUid}` : `${targetUid}_${currentUser.uid}`;
                
                const badge = currentChatUser.isVerified ? tickHTML : '';
                document.getElementById('chat-header-name').innerHTML = currentChatUser.name + badge;
                document.getElementById('chat-header-emoji').innerText = currentChatUser.emoji;
                document.getElementById('messages-list').innerHTML = "";
                document.getElementById('chat-room').classList.remove('hidden');
                document.getElementById('chat-menu').classList.remove('show');
                
                checkBlockStatus(targetUid);

                // Listen for messages
                db.ref(`chats/${currentChatId}/messages`).off(); // Remove old listeners
                db.ref(`chats/${currentChatId}/messages`).on('value', (snapshot) => {
                    const list = document.getElementById('messages-list');
                    list.innerHTML = "";
                    if (snapshot.exists()) {
                        snapshot.forEach((c) => {
                            const msg = c.val();
                            const key = c.key;
                            renderMessage(msg, key);
                            
                            // Mark as SEEN if message is from OTHER user
                            if (msg.sender !== currentUser.uid && msg.status !== 'seen') {
                                db.ref(`chats/${currentChatId}/messages/${key}`).update({ status: 'seen' });
                            }
                        });
                        list.scrollTop = list.scrollHeight;
                    }
                });
            } catch (e) {
                showToast("Error opening chat: " + e.message);
            }
        }

        function closeChat() { 
            document.getElementById('chat-room').classList.add('hidden'); 
            if(currentChatId) db.ref(`chats/${currentChatId}/messages`).off();
            currentChatId = null; 
            currentChatUser = null;
            loadChats(); 
        }

        function deleteCurrentChat() {
            if(!currentChatId) return;
            confirmAction("Delete Chat", "Clear this conversation from your list?", () => {
                // Deleting from "userChats" hides it from the list
                db.ref(`userChats/${currentUser.uid}/${currentChatId}`).remove().then(() => {
                    closeChat();
                });
                // Optional: To delete actual messages, one would use db.ref(`chats/${currentChatId}`).remove(), 
                // but usually we only remove the reference for the user unless it's a "Delete for Everyone" feature.
            });
        }

        // --- BLOCKING LOGIC ---
        async function checkBlockStatus(otherUid) {
            const inputArea = document.getElementById('chat-input-area');
            const blockedMsgBar = document.getElementById('blocked-msg-bar');
            const unblockBtnBar = document.getElementById('unblock-btn-bar');

            // Reset UI
            inputArea.style.display = 'none';
            blockedMsgBar.style.display = 'none';
            unblockBtnBar.style.display = 'none';

            // 1. Check if I blocked them
            const iBlockedSnap = await db.ref(`blocked/${currentUser.uid}/${otherUid}`).get();
            if (iBlockedSnap.exists()) {
                unblockBtnBar.style.display = 'flex';
                return;
            }

            // 2. Check if they blocked me
            const theyBlockedSnap = await db.ref(`blocked/${otherUid}/${currentUser.uid}`).get();
            if (theyBlockedSnap.exists()) {
                blockedMsgBar.style.display = 'block';
                return;
            }

            // No blocks
            inputArea.style.display = 'flex';
        }

        function blockCurrentUser() {
            if(!currentChatUser) return;
            confirmAction("Block User", `Are you sure you want to block ${currentChatUser.name}?`, () => {
                db.ref(`blocked/${currentUser.uid}/${currentChatUser.uid}`).set(true).then(() => { 
                    showToast("User Blocked");
                    checkBlockStatus(currentChatUser.uid);
                    document.getElementById('chat-menu').classList.remove('show');
                });
            });
        }

        function unblockCurrentChatUser() {
            if(!currentChatUser) return;
            confirmAction("Unblock User", "Are you sure you want to unblock this user?", () => {
                db.ref(`blocked/${currentUser.uid}/${currentChatUser.uid}`).remove().then(() => {
                    showToast("User Unblocked");
                    checkBlockStatus(currentChatUser.uid);
                });
            });
        }

        function unblock(uid) {
            confirmAction("Unblock", "Unblock this user?", () => {
                db.ref(`blocked/${currentUser.uid}/${uid}`).remove().then(() => showBlockedList());
            });
        }

        function renderMessage(msg, key) {
            const isMe = msg.sender === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'msg-sent' : 'msg-received'}`;
            let content = msg.content;
            
            // Basic XSS protection for text
            if(msg.type === 'text') {
                const txt = document.createElement('textarea');
                txt.innerHTML = content;
                content = txt.value;
            }
            
            let statusIcon = '';
            if (isMe) {
                const colorClass = msg.status === 'seen' ? 'seen' : '';
                statusIcon = `<i class="fas fa-check-double msg-status ${colorClass}"></i>`;
            }

            div.innerHTML = `${content}
                <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:4px;">
                    <span class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    ${statusIcon}
                </div>
                <div class="msg-delete" onclick="deleteMessage('${key}')"><i class="fas fa-trash"></i></div>`;
            document.getElementById('messages-list').appendChild(div);
        }
        
        function sendTextMessage() {
            const text = document.getElementById('message-input').value.trim();
            if(!text) return;

            db.ref(`blocked/${currentChatUser.uid}/${currentUser.uid}`).get().then(s => {
                if(s.exists()) {
                    showToast("You cannot send messages");
                    checkBlockStatus(currentChatUser.uid); 
                } else {
                    pushMessage('text', text);
                    document.getElementById('message-input').value = "";
                }
            });
        }

        function pushMessage(type, content) {
            const msgData = { sender: currentUser.uid, type, content, timestamp: Date.now(), status: 'sent' };
            db.ref(`chats/${currentChatId}/messages`).push(msgData);
            
            const meta = { lastMessage: type==='text' ? content : 'Media', timestamp: Date.now(), with: currentChatUser.uid };
            // Update my chat list
            db.ref(`userChats/${currentUser.uid}/${currentChatId}`).update(meta);
            // Update their chat list
            db.ref(`userChats/${currentChatUser.uid}/${currentChatId}`).update({ ...meta, with: currentUser.uid });
        }

        function deleteMessage(key) {
            confirmAction("Delete", "Delete message?", () => {
                db.ref(`chats/${currentChatId}/messages/${key}`).remove();
            });
        }

        function loadChats() {
            const listDiv = document.getElementById('chat-list-container');
            db.ref(`userChats/${currentUser.uid}`).on('value', (snapshot) => {
                listDiv.innerHTML = "";
                if (!snapshot.exists()) { listDiv.innerHTML = '<p style="text-align:center;">No chats</p>'; return; }
                
                snapshot.forEach((c) => {
                    const meta = c.val();
                    db.ref(`users/${meta.with}`).once('value').then((u) => {
                        if(u.exists()){
                            const user = u.val();
                            const badge = user.isVerified ? tickHTML : '';
                            const div = document.createElement('div');
                            div.className = 'user-list-item';
                            div.innerHTML = `
                                <div class="avatar">${user.emoji}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name} ${badge}</div>
                                    <div class="user-meta">${meta.lastMessage}</div>
                                </div>
                                <button style="color:red; background:none;" onclick="deleteEntireChat('${c.key}', event)"><i class="fas fa-trash"></i></button>
                            `;
                            div.onclick = (e) => { if(!e.target.closest('button')) openChat(meta.with); };
                            listDiv.appendChild(div);
                        }
                    });
                });
            });
        }

        function deleteEntireChat(id, e) {
            if(e) e.stopPropagation();
            confirmAction("Delete", "Remove chat from your list?", () => {
                db.ref(`userChats/${currentUser.uid}/${id}`).remove();
            });
        }
        
        function showBlockedList() {
            switchTab('blocked');
            document.getElementById('main-menu').classList.remove('show');
            const cont = document.getElementById('blocked-list-container');
            
            db.ref(`blocked/${currentUser.uid}`).on('value', snap => {
                cont.innerHTML = "";
                if(!snap.exists()) {
                    cont.innerHTML = "<p style='text-align:center; color:gray;'>No blocked users</p>";
                    return;
                }
                snap.forEach(b => {
                    db.ref(`users/${b.key}`).once('value').then(u => {
                        if(u.exists()) {
                            const div = document.createElement('div');
                            div.className = 'user-list-item';
                            div.innerHTML = `<div class="user-name">${u.val().name}</div><button class="btn-outline" style="width:auto;" onclick="unblock('${b.key}')">Unblock</button>`;
                            cont.appendChild(div);
                        }
                    });
                });
            });
        }
        
        function viewChatProfile() {
            const p = document.getElementById('profile-preview');
            p.classList.remove('hidden');
            const badge = currentChatUser.isVerified ? tickHTML.replace('18px', '24px').replace('9px','12px') : '';
            document.getElementById('preview-emoji').innerText = currentChatUser.emoji;
            document.getElementById('preview-name').innerHTML = currentChatUser.name + badge;
            document.getElementById('preview-username').innerText = "@" + currentChatUser.username;
        }

        function closeProfilePreview() { document.getElementById('profile-preview').classList.add('hidden'); }
        function toggleChatMenu() { document.getElementById('chat-menu').classList.toggle('show'); }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        let confirmCb = null;
        function confirmAction(t, m, cb) {
            document.getElementById('confirm-title').innerText = t;
            document.getElementById('confirm-msg').innerText = m;
            document.getElementById('confirm-modal').style.display = 'flex';
            confirmCb = cb;
        }
        document.getElementById('confirm-yes-btn').onclick = () => { if(confirmCb) confirmCb(); closeConfirm(); };
        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; confirmCb = null; }

    </script>
</body>
    </html>
